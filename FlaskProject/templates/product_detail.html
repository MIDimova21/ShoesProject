{% extends "base.html" %}

{% block link %}
<link rel="stylesheet" href="{{ url_for('static', filename='base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='product_detail.css') }}">
{% endblock %}

{% block content %}
<div class="product-detail-container">
  <div class="breadcrumb">
    <a href="{{ url_for('catalog.show_catalog') }}">Каталог</a>
    <span>›</span>
    <a href="{{ url_for('catalog.show_catalog', category=product.category) }}">{{ product.category }}</a>
    <span>›</span>
    <span>{{ product.name }}</span>
  </div>

  <div class="product-main">
    <div class="product-gallery">
      <div class="main-image">
        <img src="{{ product.image_url }}" alt="{{ product.name }}">
      </div>
    </div>

    <div class="product-info-section">
      <h1 class="product-title">{{ product.name }}</h1>
      
      <div class="product-rating">
        <div class="stars">
          {% for i in range(1, 6) %}
            {% if i <= avg_rating %}
              <span class="star filled">★</span>
            {% else %}
              <span class="star">★</span>
            {% endif %}
          {% endfor %}
        </div>
        <span class="rating-text">{{ "%.1f"|format(avg_rating) }} ({{ reviews_count }} отзива)</span>
      </div>

      <div class="product-price-section">
        <p class="price">{{ product.price }} лв</p>
      </div>

      <div class="product-characteristics">
        <h3>Характеристики:</h3>
        <ul>
          <li><strong>Категория:</strong> {{ product.category }}</li>
          <li><strong>Цвят:</strong> {{ product.color }}</li>
          <li><strong>Налични размери:</strong> {{ product.sizes }}</li>
          <li><strong>Наличност:</strong> 
            {% if product.stock > 0 %}
              <span class="in-stock">{{ product.stock }} бр. в наличност</span>
            {% else %}
              <span class="out-of-stock">Изчерпан</span>
            {% endif %}
          </li>
        </ul>
      </div>

      {% if current_user.is_authenticated %}
        <form method="POST" action="{{ url_for('cart.add_to_cart', product_id=product.product_id) }}" class="add-to-cart-section">
          <div class="size-selector">
            <label>Изберете размер:</label>
            <div class="size-options">
              {% for size in product.sizes.split(",") %}
                <label class="size-option">
                  <input type="radio" name="size" value="{{ size.strip() }}" required>
                  <span>{{ size.strip() }}</span>
                </label>
              {% endfor %}
            </div>
          </div>
          
          <button type="submit" class="btn-add-to-cart">Добави в количката</button>
        </form>
      {% else %}
        <a href="{{ url_for('auth.login') }}" class="btn-login">Влезте в профила си, за да пазарувате</a>
      {% endif %}
    </div>
  </div>

  <div class="reviews-section">
    <h2>Отзиви и рейтинг ({{ reviews_count }})</h2>
    
    <div class="rating-overview">
      <div class="rating-summary">
        <div class="avg-rating-big">{{ "%.1f"|format(avg_rating) }}</div>
        <div class="stars-big">
          {% for i in range(1, 6) %}
            {% if i <= avg_rating %}
              <span class="star filled">★</span>
            {% else %}
              <span class="star">★</span>
            {% endif %}
          {% endfor %}
        </div>
        <p>Базирано на {{ reviews_count }} отзива</p>
      </div>
    </div>

    {% if current_user.is_authenticated %}
      <div class="add-review-section">
        <h3>Оставете вашето мнение</h3>
        <form method="POST" action="{{ url_for('review.add_review', product_id=product.product_id) }}" class="review-form">
          <div class="rating-input">
            <label>Вашият рейтинг:</label>
            <div class="star-rating-input">
              <input type="radio" id="star5" name="rating" value="5" required>
              <label for="star5" class="star-label">★</label>
              <input type="radio" id="star4" name="rating" value="4">
              <label for="star4" class="star-label">★</label>
              <input type="radio" id="star3" name="rating" value="3">
              <label for="star3" class="star-label">★</label>
              <input type="radio" id="star2" name="rating" value="2">
              <label for="star2" class="star-label">★</label>
              <input type="radio" id="star1" name="rating" value="1">
              <label for="star1" class="star-label">★</label>
            </div>
          </div>

          <div class="comment-input">
            <label>Вашият коментар:</label>
            <textarea name="comment" rows="4" placeholder="Споделете вашето мнение за продукта..."></textarea>
          </div>

          <button type="submit" class="btn-submit-review">Публикувай отзив</button>
        </form>
      </div>
    {% else %}
      <p class="login-prompt">
        <a href="{{ url_for('auth.login') }}">Влезте в профила си</a>, за да оставите отзив.
      </p>
    {% endif %}

    <div class="reviews-list">
      {% if reviews %}
        {% for review in reviews %}
          <div class="review-card">
            <div class="review-header">
              <div class="reviewer-info">
                <img src="{{ url_for('static', filename='images/' ~ review.user.first_name ~ '_pfp.png') }}"
                     onerror="this.src='{{ url_for('static', filename='images/account.png') }}'"
                     alt="Profile"
                     class="reviewer-avatar">
                <div>
                  <p class="reviewer-name">{{ review.user.first_name }} {{ review.user.last_name[0] }}.</p>
                  <p class="review-date">{{ review.created_at.strftime('%d.%m.%Y') }}</p>
                </div>
              </div>
              <div class="review-rating">
                {% for i in range(1, 6) %}
                  {% if i <= review.rating %}
                    <span class="star filled">★</span>
                  {% else %}
                    <span class="star">★</span>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            {% if review.comment %}
              <p class="review-comment">{{ review.comment }}</p>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p class="no-reviews">Все още няма отзиви за този продукт. Бъдете първият, който ще остави мнение!</p>
      {% endif %}
    </div>
  </div>
</div>

{% for message in get_flashed_messages() %}
  <div class="flash-message">{{ message }}</div>
{% endfor %}

<script>
const starInputs = document.querySelectorAll('.star-rating-input input');
const starLabels = document.querySelectorAll('.star-rating-input label');

starLabels.forEach((label, index) => {
  label.addEventListener('mouseenter', () => {
    highlightStars(5 - index);
  });
});

document.querySelector('.star-rating-input').addEventListener('mouseleave', () => {
  const checked = document.querySelector('.star-rating-input input:checked');
  if (checked) {
    highlightStars(parseInt(checked.value));
  } else {
    highlightStars(0);
  }
});

starInputs.forEach(input => {
  input.addEventListener('change', () => {
    highlightStars(parseInt(input.value));
  });
});

function highlightStars(rating) {
  starLabels.forEach((label, index) => {
    if (5 - index <= rating) {
      label.classList.add('active');
    } else {
      label.classList.remove('active');
    }
  });
}
</script>
{% endblock %}